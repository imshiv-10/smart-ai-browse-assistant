var E=Object.defineProperty;var b=(c,t,e)=>t in c?E(c,t,{enumerable:!0,configurable:!0,writable:!0,value:e}):c[t]=e;var d=(c,t,e)=>b(c,typeof t!="symbol"?t+"":t,e);import{b as n}from"./browser-polyfill-DY9jeWLg.js";class O{constructor(t){d(this,"backendUrl");d(this,"localLLMUrl");this.backendUrl=t.backendUrl,this.localLLMUrl=t.localLLMUrl}async summarizeLocal(t){const e=this.buildSummaryPrompt(t),s=await fetch(`${this.localLLMUrl}/v1/chat/completions`,{method:"POST",headers:{"Content-Type":"application/json"},body:JSON.stringify({model:"local-model",messages:[{role:"system",content:"You are a helpful assistant that summarizes web pages. Provide concise, informative summaries."},{role:"user",content:e}],temperature:.7,max_tokens:1e3})});if(!s.ok)throw new Error(`Local LLM request failed: ${s.status}`);const a=await s.json();return this.parseSummaryResponse(a.choices[0].message.content)}async summarizeRemote(t){var a;const e=await fetch(`${this.backendUrl}/api/summarize`,{method:"POST",headers:{"Content-Type":"application/json"},body:JSON.stringify({content:t})});if(!e.ok)throw new Error(`Backend request failed: ${e.status}`);const s=await e.json();if(!s.success||!s.data)throw new Error(((a=s.error)==null?void 0:a.message)||"Summarization failed");return s.data}async compareProduct(t,e){var o;const s=await fetch(`${this.backendUrl}/api/compare`,{method:"POST",headers:{"Content-Type":"application/json"},body:JSON.stringify({url:t,content:e})});if(!s.ok)throw new Error(`Comparison request failed: ${s.status}`);const a=await s.json();if(!a.success||!a.data)throw new Error(((o=a.error)==null?void 0:o.message)||"Comparison failed");return a.data}async chatLocal(t,e){const s=this.buildChatSystemPrompt(e),a=await fetch(`${this.localLLMUrl}/v1/chat/completions`,{method:"POST",headers:{"Content-Type":"application/json"},body:JSON.stringify({model:"local-model",messages:[{role:"system",content:s},...t.map(i=>({role:i.role,content:i.content}))],temperature:.7,max_tokens:2e3})});if(!a.ok)throw new Error(`Local chat request failed: ${a.status}`);const o=await a.json();return{id:crypto.randomUUID(),role:"assistant",content:o.choices[0].message.content,timestamp:new Date().toISOString()}}async chatRemote(t,e){var o;const s=await fetch(`${this.backendUrl}/api/chat`,{method:"POST",headers:{"Content-Type":"application/json"},body:JSON.stringify({messages:t,context:e})});if(!s.ok)throw new Error(`Chat request failed: ${s.status}`);const a=await s.json();if(!a.success||!a.data)throw new Error(((o=a.error)==null?void 0:o.message)||"Chat failed");return a.data.message}async*streamChatLocal(t,e){var h,p,S,m;const s=this.buildChatSystemPrompt(e),a=await fetch(`${this.localLLMUrl}/v1/chat/completions`,{method:"POST",headers:{"Content-Type":"application/json"},body:JSON.stringify({model:"local-model",messages:[{role:"system",content:s},...t.map(l=>({role:l.role,content:l.content}))],temperature:.7,max_tokens:2e3,stream:!0})});if(!a.ok)throw new Error(`Streaming request failed: ${a.status}`);const o=(h=a.body)==null?void 0:h.getReader();if(!o)throw new Error("No response body");const i=new TextDecoder;let u="";for(;;){const{done:l,value:C}=await o.read();if(l)break;u+=i.decode(C,{stream:!0});const g=u.split(`
`);u=g.pop()||"";for(const y of g)if(y.startsWith("data: ")){const w=y.slice(6);if(w==="[DONE]"){yield{content:"",done:!0};return}try{const f=((m=(S=(p=JSON.parse(w).choices)==null?void 0:p[0])==null?void 0:S.delta)==null?void 0:m.content)||"";f&&(yield{content:f,done:!1})}catch{}}}}async checkLocalLLMHealth(){try{return(await fetch(`${this.localLLMUrl}/v1/models`,{method:"GET",signal:AbortSignal.timeout(5e3)})).ok}catch{return!1}}async checkBackendHealth(){try{return(await fetch(`${this.backendUrl}/health`,{method:"GET",signal:AbortSignal.timeout(5e3)})).ok}catch{return!1}}buildSummaryPrompt(t){let e=`Please summarize the following web page:

`;return e+=`Title: ${t.title}
`,e+=`URL: ${t.url}
`,e+=`Page Type: ${t.pageType}

`,e+=`Content:
${t.text.substring(0,8e3)}

`,t.product&&(e+=`Product Info:
`,e+=`- Name: ${t.product.name}
`,e+=`- Price: ${t.product.currency} ${t.product.price}
`,e+=`- Rating: ${t.product.rating}/5 (${t.product.reviewCount} reviews)
`),e+=`
Provide a concise summary with key points. Format your response as JSON:
{
  "summary": "A 2-3 sentence summary",
  "keyPoints": ["point 1", "point 2", "point 3"],
  "sentiment": "positive|negative|neutral",
  "topics": ["topic1", "topic2"]
}`,e}buildChatSystemPrompt(t){let e="You are a helpful assistant that helps users understand and interact with web pages. ";return e+=`You have access to the following page content:

`,e+=`Title: ${t.title}
`,e+=`URL: ${t.url}
`,e+=`Page Type: ${t.pageType}

`,e+=`Content:
${t.text.substring(0,6e3)}

`,t.product&&(e+=`This is a product page for: ${t.product.name}
`,e+=`Price: ${t.product.currency} ${t.product.price}
`,e+=`Rating: ${t.product.rating}/5

`),e+="Answer questions about this page helpfully and accurately. ",e+="If asked about something not on the page, say so clearly.",e}parseSummaryResponse(t){try{const e=t.match(/\{[\s\S]*\}/);if(e)return JSON.parse(e[0])}catch{}return{summary:t,keyPoints:[]}}}const T={backendUrl:"http://localhost:8000",localLLMUrl:"http://localhost:1234",useLocalLLM:!0,localLLMThreshold:4e3,theme:"system",maxHistoryLength:50,autoSummarize:!1},r={SETTINGS:"settings",CHAT_SESSIONS:"chat_sessions",CURRENT_SESSION:"current_session"};class I{async getSettings(){const t=await n.storage.local.get(r.SETTINGS);return{...T,...t[r.SETTINGS]}}async updateSettings(t){const s={...await this.getSettings(),...t};return await n.storage.local.set({[r.SETTINGS]:s}),s}async setDefaultSettings(){await n.storage.local.set({[r.SETTINGS]:T})}async getChatSessions(){return(await n.storage.local.get(r.CHAT_SESSIONS))[r.CHAT_SESSIONS]||[]}async getChatSession(t){return(await this.getChatSessions()).find(s=>s.id===t)||null}async getOrCreateSessionForUrl(t,e){const a=(await this.getChatSessions()).find(i=>i.pageUrl===t);if(a)return a;const o={id:crypto.randomUUID(),pageUrl:t,pageTitle:e,messages:[],createdAt:new Date().toISOString(),updatedAt:new Date().toISOString()};return await this.saveChatSession(o),o}async saveChatSession(t){const e=await this.getChatSessions(),s=e.findIndex(i=>i.id===t.id);t.updatedAt=new Date().toISOString(),s>=0?e[s]=t:e.unshift(t);const a=await this.getSettings(),o=e.slice(0,a.maxHistoryLength);await n.storage.local.set({[r.CHAT_SESSIONS]:o})}async addMessageToSession(t,e){const s=await this.getChatSession(t);return s?(s.messages.push(e),await this.saveChatSession(s),s):null}async deleteChatSession(t){const s=(await this.getChatSessions()).filter(a=>a.id!==t);await n.storage.local.set({[r.CHAT_SESSIONS]:s})}async clearChatSessions(){await n.storage.local.set({[r.CHAT_SESSIONS]:[]})}async getCurrentSessionId(){return(await n.storage.local.get(r.CURRENT_SESSION))[r.CURRENT_SESSION]||null}async setCurrentSessionId(t){t?await n.storage.local.set({[r.CURRENT_SESSION]:t}):await n.storage.local.remove(r.CURRENT_SESSION)}async exportData(){const t=await this.getSettings(),e=await this.getChatSessions();return{settings:t,sessions:e}}async importData(t){t.settings&&await this.updateSettings(t.settings),t.sessions&&await n.storage.local.set({[r.CHAT_SESSIONS]:t.sessions})}async getStorageInfo(){return n.storage.local.getBytesInUse?{bytesUsed:await n.storage.local.getBytesInUse(null),quota:10*1024*1024}:{bytesUsed:0,quota:10*1024*1024}}}export{O as A,I as S};
